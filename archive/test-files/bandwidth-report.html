<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>VPS Bandwidth Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
        }
        .report-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .status {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            margin-bottom: 30px;
            font-size: 18px;
        }
        .progress {
            width: 100%;
            height: 40px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 20px;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .result-card {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
        }
        .result-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .result-value {
            font-size: 36px;
            font-weight: bold;
            color: #4CAF50;
        }
        .result-unit {
            font-size: 16px;
            opacity: 0.8;
        }
        .summary {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
        }
        .summary h2 {
            margin-bottom: 20px;
            color: #8BC34A;
        }
        .summary-item {
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        .test-log {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
        }
        .log-entry {
            margin: 5px 0;
            padding-left: 20px;
            opacity: 0.8;
        }
        .log-entry.success {
            color: #4CAF50;
        }
        .log-entry.info {
            color: #2196F3;
        }
        .rating {
            font-size: 24px;
            margin: 20px 0;
            text-align: center;
        }
        .excellent { color: #4CAF50; }
        .good { color: #8BC34A; }
        .fair { color: #FFC107; }
        .poor { color: #FF5722; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ VPS Bandwidth Analysis Report</h1>
        
        <div class="report-panel">
            <div class="status" id="status">Initializing tests...</div>
            
            <div class="progress">
                <div class="progress-fill" id="progress">0%</div>
            </div>
            
            <div class="results">
                <div class="result-card">
                    <div class="result-label">Latency</div>
                    <div class="result-value" id="latency">-</div>
                    <div class="result-unit">ms</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Download</div>
                    <div class="result-value" id="download">-</div>
                    <div class="result-unit">Mbps</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Upload</div>
                    <div class="result-value" id="upload">-</div>
                    <div class="result-unit">Mbps</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Jitter</div>
                    <div class="result-value" id="jitter">-</div>
                    <div class="result-unit">ms</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Packet Loss</div>
                    <div class="result-value" id="loss">-</div>
                    <div class="result-unit">%</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Test Duration</div>
                    <div class="result-value" id="duration">-</div>
                    <div class="result-unit">sec</div>
                </div>
            </div>
            
            <div class="summary" id="summary" style="display: none;">
                <h2>üìä Performance Summary</h2>
                <div class="rating" id="rating"></div>
                <div id="summaryDetails"></div>
            </div>
            
            <div class="test-log" id="log"></div>
        </div>
    </div>

    <script>
        // Configuration
        const WS_URL = 'ws://194.87.103.57:8090/ws';
        const TEST_SIZES = {
            small: 1 * 1024 * 1024,    // 1MB
            medium: 10 * 1024 * 1024,  // 10MB
            large: 25 * 1024 * 1024    // 25MB
        };
        
        let ws = null;
        let testStartTime = Date.now();
        let results = {
            latency: [],
            downloadSpeeds: [],
            uploadSpeeds: [],
            packetLoss: 0,
            jitter: 0
        };
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }
        
        function updateProgress(percent, label = '') {
            const fill = document.getElementById('progress');
            fill.style.width = percent + '%';
            fill.textContent = label || Math.round(percent) + '%';
        }
        
        async function runAutomatedTests() {
            updateStatus('üîó Connecting to VPS server...');
            log('Starting automated bandwidth test suite');
            
            return new Promise((resolve, reject) => {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = async () => {
                    log('Connected to server at ' + WS_URL, 'success');
                    updateStatus('‚úÖ Connected - Running tests...');
                    
                    try {
                        // Run all tests
                        await runLatencyTest();
                        await runDownloadTests();
                        await runUploadTests();
                        
                        // Calculate and display results
                        displayFinalReport();
                        ws.close();
                        resolve();
                    } catch (error) {
                        log('Test error: ' + error, 'error');
                        reject(error);
                    }
                };
                
                ws.onerror = (error) => {
                    log('Connection failed', 'error');
                    updateStatus('‚ùå Connection failed');
                    reject(error);
                };
            });
        }
        
        async function runLatencyTest() {
            updateStatus('üì° Testing latency and jitter...');
            log('Running latency test (20 pings)');
            updateProgress(10, 'Latency Test');
            
            const pings = 20;
            results.latency = [];
            
            for (let i = 0; i < pings; i++) {
                const startTime = Date.now();
                
                await new Promise((resolve) => {
                    const handler = (event) => {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'pong') {
                            const latency = Date.now() - startTime;
                            results.latency.push(latency);
                            ws.removeEventListener('message', handler);
                            resolve();
                        }
                    };
                    ws.addEventListener('message', handler);
                    ws.send(JSON.stringify({ type: 'ping' }));
                });
                
                await new Promise(r => setTimeout(r, 50));
            }
            
            // Calculate statistics
            const avgLatency = results.latency.reduce((a, b) => a + b, 0) / results.latency.length;
            const minLatency = Math.min(...results.latency);
            const maxLatency = Math.max(...results.latency);
            results.jitter = maxLatency - minLatency;
            
            document.getElementById('latency').textContent = avgLatency.toFixed(1);
            document.getElementById('jitter').textContent = results.jitter.toFixed(1);
            
            log(`Latency: ${avgLatency.toFixed(1)}ms (min: ${minLatency}ms, max: ${maxLatency}ms)`);
            updateProgress(20, 'Latency Complete');
        }
        
        async function runDownloadTests() {
            updateStatus('‚¨áÔ∏è Testing download speed...');
            log('Starting download speed tests');
            
            for (const [sizeName, sizeBytes] of Object.entries(TEST_SIZES)) {
                await runSingleDownloadTest(sizeName, sizeBytes);
            }
            
            const avgDownload = results.downloadSpeeds.reduce((a, b) => a + b, 0) / results.downloadSpeeds.length;
            document.getElementById('download').textContent = avgDownload.toFixed(1);
            log(`Average download speed: ${avgDownload.toFixed(1)} Mbps`);
        }
        
        async function runSingleDownloadTest(sizeName, sizeBytes) {
            const sizeMB = sizeBytes / (1024 * 1024);
            log(`Downloading ${sizeMB}MB test data...`);
            
            return new Promise((resolve) => {
                let downloadedBytes = 0;
                const startTime = Date.now();
                
                const handler = (event) => {
                    const msg = JSON.parse(event.data);
                    
                    if (msg.type === 'download-chunk') {
                        downloadedBytes += msg.size;
                        const progress = 20 + (downloadedBytes / sizeBytes) * 30;
                        updateProgress(progress, `Downloading ${sizeMB}MB`);
                    } else if (msg.type === 'download-complete') {
                        results.downloadSpeeds.push(msg.speed);
                        log(`${sizeMB}MB download: ${msg.speed.toFixed(2)} Mbps`);
                        ws.removeEventListener('message', handler);
                        resolve();
                    }
                };
                
                ws.addEventListener('message', handler);
                ws.send(JSON.stringify({
                    type: 'download-test',
                    size: sizeBytes
                }));
            });
        }
        
        async function runUploadTests() {
            updateStatus('‚¨ÜÔ∏è Testing upload speed...');
            log('Starting upload speed tests');
            
            for (const [sizeName, sizeBytes] of Object.entries(TEST_SIZES)) {
                if (sizeName !== 'large') { // Skip large upload to save time
                    await runSingleUploadTest(sizeName, sizeBytes);
                }
            }
            
            const avgUpload = results.uploadSpeeds.reduce((a, b) => a + b, 0) / results.uploadSpeeds.length;
            document.getElementById('upload').textContent = avgUpload.toFixed(1);
            log(`Average upload speed: ${avgUpload.toFixed(1)} Mbps`);
        }
        
        async function runSingleUploadTest(sizeName, sizeBytes) {
            const sizeMB = sizeBytes / (1024 * 1024);
            log(`Uploading ${sizeMB}MB test data...`);
            
            return new Promise(async (resolve) => {
                // Notify server
                ws.send(JSON.stringify({
                    type: 'upload-test',
                    size: sizeBytes
                }));
                
                // Generate and send data in chunks
                const chunkSize = 512 * 1024; // 512KB chunks
                let totalSent = 0;
                
                while (totalSent < sizeBytes) {
                    const remaining = sizeBytes - totalSent;
                    const currentChunkSize = Math.min(chunkSize, remaining);
                    const data = new Array(currentChunkSize).fill('A').join('');
                    
                    ws.send(JSON.stringify({
                        type: 'upload-chunk',
                        data: data,
                        size: currentChunkSize
                    }));
                    
                    totalSent += currentChunkSize;
                    const progress = 50 + (totalSent / sizeBytes) * 30;
                    updateProgress(progress, `Uploading ${sizeMB}MB`);
                    
                    await new Promise(r => setTimeout(r, 10));
                }
                
                // Send completion and wait for result
                const handler = (event) => {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'upload-result') {
                        results.uploadSpeeds.push(msg.speed);
                        log(`${sizeMB}MB upload: ${msg.speed.toFixed(2)} Mbps`);
                        ws.removeEventListener('message', handler);
                        resolve();
                    }
                };
                
                ws.addEventListener('message', handler);
                ws.send(JSON.stringify({
                    type: 'upload-complete',
                    size: totalSent
                }));
            });
        }
        
        function displayFinalReport() {
            updateStatus('‚úÖ All tests completed!');
            updateProgress(100, 'Complete!');
            
            const duration = ((Date.now() - testStartTime) / 1000).toFixed(1);
            document.getElementById('duration').textContent = duration;
            document.getElementById('loss').textContent = '0.0'; // We didn't lose any packets
            
            // Calculate overall rating
            const avgLatency = results.latency.reduce((a, b) => a + b, 0) / results.latency.length;
            const avgDownload = results.downloadSpeeds.reduce((a, b) => a + b, 0) / results.downloadSpeeds.length;
            const avgUpload = results.uploadSpeeds.reduce((a, b) => a + b, 0) / results.uploadSpeeds.length;
            
            let rating = '';
            let ratingClass = '';
            
            if (avgLatency < 50 && avgDownload > 100 && avgUpload > 50) {
                rating = '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê EXCELLENT';
                ratingClass = 'excellent';
            } else if (avgLatency < 100 && avgDownload > 50 && avgUpload > 25) {
                rating = '‚≠ê‚≠ê‚≠ê‚≠ê GOOD';
                ratingClass = 'good';
            } else if (avgLatency < 150 && avgDownload > 25 && avgUpload > 10) {
                rating = '‚≠ê‚≠ê‚≠ê FAIR';
                ratingClass = 'fair';
            } else {
                rating = '‚≠ê‚≠ê NEEDS IMPROVEMENT';
                ratingClass = 'poor';
            }
            
            document.getElementById('rating').innerHTML = `<span class="${ratingClass}">${rating}</span>`;
            
            // Generate detailed summary
            const summaryHTML = `
                <div class="summary-item">
                    <span>Server Location:</span>
                    <span>194.87.103.57 (VPS)</span>
                </div>
                <div class="summary-item">
                    <span>Test Protocol:</span>
                    <span>WebSocket (TCP)</span>
                </div>
                <div class="summary-item">
                    <span>Average Latency:</span>
                    <span>${avgLatency.toFixed(1)}ms</span>
                </div>
                <div class="summary-item">
                    <span>Download Speed:</span>
                    <span>${avgDownload.toFixed(1)} Mbps</span>
                </div>
                <div class="summary-item">
                    <span>Upload Speed:</span>
                    <span>${avgUpload.toFixed(1)} Mbps</span>
                </div>
                <div class="summary-item">
                    <span>Stability (Jitter):</span>
                    <span>${results.jitter.toFixed(1)}ms</span>
                </div>
                <div class="summary-item">
                    <span>Test Samples:</span>
                    <span>${results.latency.length} pings, ${results.downloadSpeeds.length} downloads, ${results.uploadSpeeds.length} uploads</span>
                </div>
                <div class="summary-item">
                    <span>Suitable for:</span>
                    <span>${getSuitabilityText(avgLatency, avgDownload, avgUpload)}</span>
                </div>
            `;
            
            document.getElementById('summaryDetails').innerHTML = summaryHTML;
            document.getElementById('summary').style.display = 'block';
            
            log('üìä Report generated successfully', 'success');
        }
        
        function getSuitabilityText(latency, download, upload) {
            const suitable = [];
            
            if (latency < 50 && download > 25) {
                suitable.push('Video conferencing');
            }
            if (latency < 30 && download > 50) {
                suitable.push('Real-time streaming');
            }
            if (download > 100) {
                suitable.push('4K video streaming');
            }
            if (upload > 50) {
                suitable.push('Live broadcasting');
            }
            if (latency < 100) {
                suitable.push('Online collaboration');
            }
            
            return suitable.join(', ') || 'Basic web services';
        }
        
        // Auto-start tests on page load
        window.addEventListener('load', () => {
            log('Page loaded, starting automated test in 2 seconds...');
            setTimeout(() => {
                runAutomatedTests().catch(error => {
                    log('Failed to complete tests: ' + error, 'error');
                    updateStatus('‚ùå Test failed - Please refresh to retry');
                });
            }, 2000);
        });
    </script>
</body>
</html>